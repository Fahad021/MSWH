

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mswh.system.models &mdash; Multiscale Solar Water Heating 2.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Multiscale Solar Water Heating
          

          
          </a>

          
            
            
              <div class="version">
                2.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../source/installation.html">Package Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/models.html">Multiscale Solar Water Heating (MSWH)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/modules.html">Python Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/legal.html">Copyright Notice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/legal.html#license-agreement">License Agreement</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Multiscale Solar Water Heating</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>mswh.system.models</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mswh.system.models</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">mswh.system.components</span> <span class="kn">import</span> <span class="n">Converter</span><span class="p">,</span> <span class="n">Storage</span><span class="p">,</span> <span class="n">Distribution</span>
<span class="kn">from</span> <span class="nn">mswh.tools.unit_converters</span> <span class="kn">import</span> <span class="n">UnitConv</span>
<span class="kn">from</span> <span class="nn">mswh.comm.label_map</span> <span class="kn">import</span> <span class="n">SwhLabels</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="System"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.models.System">[docs]</a><span class="k">class</span> <span class="nc">System</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Project level system models:</span>

<span class="sd">    * Assembles system configurations</span>
<span class="sd">    * Performs timestep simulation</span>
<span class="sd">    * Returns annual and timestep project and household</span>
<span class="sd">      level results, such as gas and electricity use, heat delivered,</span>
<span class="sd">      unmet demand and solar fraction.</span>

<span class="sd">    Parameters:</span>

<span class="sd">        sys_params: pd df</span>
<span class="sd">            Main system component performance parameters per project</span>
<span class="sd">            Default: None (default model parameters will get used)</span>

<span class="sd">        backup_params: pd df</span>
<span class="sd">            Backup system performance parameters per project.</span>
<span class="sd">            It should contain a household ID column, otherwise</span>
<span class="sd">            columns identical to params.</span>

<span class="sd">        sys_sizes: pd df</span>
<span class="sd">            Main system component sizes</span>
<span class="sd">            Default: 1. (see individual components for specifics)</span>

<span class="sd">        backup_sizes: pd df</span>
<span class="sd">            Backup system component sizes, contains household id column</span>
<span class="sd">            Default: 1. (see individual components for specifics)</span>

<span class="sd">        weather: pd df</span>
<span class="sd">            Weather data timeseries.</span>
<span class="sd">            Number of rows equals the number of timesteps. Can be</span>
<span class="sd">            generated using the Source.irradiation_and_water_main</span>
<span class="sd">            method</span>

<span class="sd">            Example:</span>

<span class="sd">            &gt;&gt;&gt; sourceASource(read_from_input_dataframes = inputs)</span>

<span class="sd">            Oakland climate zone in CEC weather data is &#39;03&#39;:</span>

<span class="sd">            &gt;&gt;&gt; self.weather = source.irradiation_and_water_main(&#39;03&#39;, method=&#39;isotropic diffuse&#39;)</span>

<span class="sd">        loads: pd df</span>
<span class="sd">            A dataframe with loads for all individual household</span>
<span class="sd">            served by the project level system. It should</span>
<span class="sd">            contain 3 columns: household id, occupancy and a column</span>
<span class="sd">            with a load array in m3 for each household.</span>

<span class="sd">            Example:</span>

<span class="sd">            &gt;&gt;&gt; loads_com = pd.DataFrame(data = [[1, occ_indiv - 1., 0.8 * load_array],[2, occ_indiv, 1. * load_array],[3, occ_indiv, 1.2 * load_array],[4, occ_indiv + 1., 1.4 * load_array]], columns = [self.c[&#39;id&#39;], self.c[&#39;occ&#39;], self.c[&#39;load_m3&#39;]])</span>

<span class="sd">        timestep: float, h</span>
<span class="sd">            Duration of a single timestep, in hours</span>
<span class="sd">            Default: 1. h</span>

<span class="sd">        log_level: None or python logger logging level,</span>
<span class="sd">            Default: logging.DEBUG</span>
<span class="sd">            This applies for a subset of the class functionality, mostly</span>
<span class="sd">            used to deprecate logger messages for certain calculations.</span>
<span class="sd">            For Example: log_level = logging.ERROR will only throw error</span>
<span class="sd">            messages and ignore INFO, DEBUG and WARNING.</span>

<span class="sd">    Examples:</span>

<span class="sd">        See :func:`mswh.system.tests.test_components &lt;mswh.system.tests.test_components&gt;` module and</span>
<span class="sd">        :func:`scripts/MSWH System Tool.ipynb &lt;scripts/MSWH System Tool.ipynb&gt;`</span>
<span class="sd">        for examples on how to use the methods as stand alone and</span>
<span class="sd">        in a system model simulation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sys_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">backup_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> \
            <span class="n">weather</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sys_sizes</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">backup_sizes</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> \
        <span class="n">loads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timestep</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>

        <span class="c1"># this is to defend from using the models wihtout</span>
        <span class="c1"># setting up the inputs as recommended</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sys_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">backup_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> \
        <span class="p">(</span><span class="n">weather</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">loads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please consult example setup either in the &quot;</span>\
            <span class="s2">&quot;test suite or in the example notebooks to &quot;</span>\
            <span class="s2">&quot;appropriatelly set up a System instance.&quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1"># log level (e.g. only partial functionality of the class</span>
        <span class="c1"># is being used and one does not desire to see all infos)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="n">log_level</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">SwhLabels</span><span class="p">()</span><span class="o">.</span><span class="n">set_prod_labels</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">SwhLabels</span><span class="p">()</span><span class="o">.</span><span class="n">set_hous_labels</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">SwhLabels</span><span class="p">()</span><span class="o">.</span><span class="n">set_res_labels</span><span class="p">()</span>

        <span class="c1"># assume individual system unless the loads contain multiple</span>
        <span class="c1"># individual household loads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">community</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># main system performance parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_params</span> <span class="o">=</span> <span class="n">sys_params</span>
        <span class="c1"># backup system performance parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backup_params</span> <span class="o">=</span> <span class="n">backup_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weather</span> <span class="o">=</span> <span class="n">weather</span>

        <span class="c1"># prepare loads</span>
        <span class="k">if</span> <span class="n">loads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># m3</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;The system did not receive any load requirement. &#39;</span>\
                  <span class="s1">&#39;Setting hot water draw to 0.01 m3/h.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># initiate household level result df assuming 4</span>
            <span class="c1"># occupants</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]],</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;occ&#39;</span><span class="p">]])</span>

            <span class="c1"># for the distribution losses</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span> <span class="o">*</span> <span class="mf">1.</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># initiate household level result df</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;occ&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w&#39;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use&#39;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use_s&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use_w&#39;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;sol_fra&#39;</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">loads</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;occ&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">loads</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;occ&#39;</span><span class="p">]]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">indiv_loads</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">loads</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">loads</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">community</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># set community load by summing individual loads</span>
            <span class="n">sum_loads</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([(</span><span class="n">loads</span> <span class="o">*</span> <span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span> <span class="o">=</span> <span class="n">sum_loads</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loads</span> <span class="o">=</span> <span class="n">loads</span> <span class="o">*</span> <span class="mf">1.</span>

            <span class="c1"># annual fractions for each household</span>
            <span class="n">ann_cons_fract</span> <span class="o">=</span> <span class="n">loads</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="c1"># this is only to avoid division zero</span>
            <span class="n">sum_loads</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]][</span>
                <span class="n">sum_loads</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

            <span class="c1"># timeseries household load fractions in the</span>
            <span class="c1"># community load profile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span> <span class="o">=</span> <span class="n">loads</span> <span class="o">*</span> <span class="mf">1.</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">loads</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span> <span class="o">/</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">sum_loads</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]]</span> <span class="o">*</span> <span class="n">loads</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">loads</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;occ&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">loads</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;occ&#39;</span><span class="p">]]</span>
            <span class="c1"># prepare for usage after simulation (+1 timestep)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>
            <span class="c1"># household load fractions in the total load</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span><span class="s1">&#39;ann_cons_fract&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ann_cons_fract</span>

            <span class="c1"># for the distribution system</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="c1"># main system component sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_sizes</span> <span class="o">=</span> <span class="n">sys_sizes</span>
        <span class="c1"># backup system component sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backup_sizes</span> <span class="o">=</span> <span class="n">backup_sizes</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">=</span> <span class="n">timestep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weather</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__weather</span>

    <span class="nd">@weather</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">weather</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Re-extracts weather timeseries if a new weather dataset</span>
<span class="sd">        is assigned to an instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__weather</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_amb</span> <span class="o">=</span> <span class="n">UnitConv</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;t_amb_C&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">degC_K</span><span class="p">(</span><span class="n">unit_in</span><span class="o">=</span><span class="s1">&#39;degC&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_wet_bulb</span> <span class="o">=</span> <span class="n">UnitConv</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;t_wet_bulb_C&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">degC_K</span><span class="p">(</span>
                <span class="n">unit_in</span><span class="o">=</span><span class="s1">&#39;degC&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inc_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;irrad_on_tilt&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_main</span> <span class="o">=</span> <span class="n">UnitConv</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;t_main_C&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">degC_K</span><span class="p">(</span>
                <span class="n">unit_in</span><span class="o">=</span><span class="s1">&#39;degC&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">month</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">season</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s1">&#39;winter&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">it_is_summer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">season</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;summer&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">it_is_winter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">season</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;winter&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hour</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Assigned weather data timeseries.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_amb</span> <span class="o">=</span> <span class="mf">293.15</span>  <span class="c1"># K</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_wet_bulb</span> <span class="o">=</span> <span class="mf">283.15</span>  <span class="c1"># K</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inc_rad</span> <span class="o">=</span> <span class="mi">800</span>  <span class="c1"># W</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_main</span> <span class="o">=</span> <span class="mf">291.15</span>  <span class="c1"># K</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">month</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">day</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">season</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;No weather data got passed to converters. &#39;</span>\
                  <span class="s1">&#39;Setting default scalar values for ambient temperature, &#39;</span>\
                  <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, and solar irradiation, </span><span class="si">{}</span><span class="s1">.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_amb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc_rad</span><span class="p">))</span>

<div class="viewcode-block" id="System.solar_thermal"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.models.System.solar_thermal">[docs]</a>    <span class="k">def</span> <span class="nf">solar_thermal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="s1">&#39;gas&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Connects the components of the solar thermal system and</span>
<span class="sd">        simulates it in discrete timesteps.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            backup: string</span>
<span class="sd">                retrofit - pulls from the basecase for each household</span>
<span class="sd">                gas, electric - instantaneous WHs (new installations)</span>

<span class="sd">        Returns:</span>

<span class="sd">            self.cons_total: pd df</span>
<span class="sd">                Consumer level energy use [W], heat rates [W],</span>
<span class="sd">                average temperatures [K],</span>
<span class="sd">                and solar fraction for the analysis period.</span>

<span class="sd">            proj_total: pd series</span>
<span class="sd">                Project level energy use [W], heat rates [W],</span>
<span class="sd">                average temperatures [K],</span>
<span class="sd">                and solar fraction for the analysis period.</span>

<span class="sd">            sol_fra: dict</span>
<span class="sd">                Solar fraction. Keys: &#39;annual&#39;, &#39;monthly&#39;</span>

<span class="sd">            pump_el_use: dict</span>
<span class="sd">                Electricity use broken into end uses</span>
<span class="sd">                &#39;dist_pump&#39; - distribution pump, if present</span>
<span class="sd">                &#39;sol_pump&#39; - solar pump</span>

<span class="sd">            ts_res: pd df</span>
<span class="sd">                Timestep project level results for all energy uses [W],</span>
<span class="sd">                heat rates [W], temperatures [K], and the load.</span>

<span class="sd">            backup_ts_cons: dict of dicts</span>
<span class="sd">                Timestep household level results for energy uses [W],</span>
<span class="sd">                and heat rates [W].</span>

<span class="sd">            rel_err: float</span>
<span class="sd">                Balancing error due to limitations of finite</span>
<span class="sd">                timestep averaging.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># initiate a dataframe with hourly results</span>
        <span class="n">ts_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># components</span>
        <span class="n">converters</span> <span class="o">=</span> <span class="n">Converter</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_params</span><span class="p">,</span>
            <span class="n">weather</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="p">,</span>
            <span class="n">sizes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_sizes</span><span class="p">,</span>
            <span class="n">log_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="n">indirect_tank</span> <span class="o">=</span> <span class="n">Storage</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_params</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;sol_tank&#39;</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_sizes</span><span class="p">,</span>
            <span class="n">timestep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">,</span>
            <span class="n">log_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="c1"># Initiate arrays to hold the results during calculation</span>
        <span class="c1"># (improved performance with arrays, assigning to df post-calc)</span>

        <span class="n">T_coil_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Q_sol_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># demand heat rate</span>
        <span class="n">Q_dem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Q_dem_with_dist_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">q_dem_balance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># input solar tank gain and loss heat rates</span>
        <span class="n">Q_coil_sol_tank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Q_loss_lower_sol_tank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Q_loss_upper_sol_tank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># output solar tank heat rates</span>
        <span class="n">Q_del_sol_tank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Q_unmet_sol_tank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Q_dump_sol_tank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Q_ovrcool_sol_tank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># tank temperature states</span>
        <span class="n">T_upper_sol_tank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">T_lower_sol_tank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">T_set</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dT_dist_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Q_dist_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># instantaneous gas wh states</span>
        <span class="n">Q_del_bckp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Q_gas_use_bckp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Q_unmet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># pump on time timestep fractions</span>
        <span class="n">Q_pump_on_fraction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># set values for the initial timestep</span>
        <span class="n">T_coil_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_main</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T_upper_sol_tank</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_main</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T_lower_sol_tank</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_main</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># simulate main system</span>
        <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">):</span>

            <span class="n">sol_col_res</span> <span class="o">=</span> <span class="n">converters</span><span class="o">.</span><span class="n">solar_collector</span><span class="p">(</span>
                    <span class="n">T_coil_out</span><span class="p">[</span><span class="n">ts</span><span class="p">],</span>
                    <span class="n">t_amb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t_amb</span><span class="p">[</span><span class="n">ts</span><span class="p">],</span>
                    <span class="n">inc_rad</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inc_rad</span><span class="p">[</span><span class="n">ts</span><span class="p">])</span>

            <span class="c1"># gross collector gain that gets fed into the tank coil</span>
            <span class="n">Q_sol_col</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_col_res</span><span class="p">[</span><span class="s1">&#39;Q_gain&#39;</span><span class="p">]</span>

            <span class="n">sto_res</span> <span class="o">=</span> <span class="n">indirect_tank</span><span class="o">.</span><span class="n">thermal_tank</span><span class="p">(</span>
                <span class="n">pre_T_amb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t_amb</span><span class="p">[</span><span class="n">ts</span><span class="p">],</span>
                <span class="n">pre_T_feed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t_main</span><span class="p">[</span><span class="n">ts</span><span class="p">],</span>
                <span class="n">pre_T_upper</span><span class="o">=</span><span class="n">T_upper_sol_tank</span><span class="p">[</span><span class="n">ts</span><span class="p">],</span>
                <span class="n">pre_T_lower</span><span class="o">=</span><span class="n">T_lower_sol_tank</span><span class="p">[</span><span class="n">ts</span><span class="p">],</span>
                <span class="n">pre_V_tap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="n">ts</span><span class="p">],</span>
                <span class="n">pre_Q_in</span><span class="o">=</span><span class="n">Q_sol_col</span><span class="p">[</span><span class="n">ts</span><span class="p">],</span>
                <span class="n">max_V_tap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load_max</span><span class="p">)</span>

            <span class="c1"># solar collector return temperature (from tank)</span>
            <span class="n">T_coil_out</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_coil_out&#39;</span><span class="p">]]</span>

            <span class="c1"># demand heat rate</span>
            <span class="n">Q_dem</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]]</span>
            <span class="n">Q_dem_with_dist_loss</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem_tot&#39;</span><span class="p">]]</span>
            <span class="n">q_dem_balance</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem_balance&#39;</span><span class="p">]]</span>

            <span class="c1"># solar tank heat sources</span>
            <span class="n">Q_coil_sol_tank</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_sol&#39;</span><span class="p">]]</span>
            <span class="n">Q_ovrcool_sol_tank</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_ovrcool_tank&#39;</span><span class="p">]]</span>

            <span class="c1"># solar tank heat sinks</span>
            <span class="n">Q_loss_lower_sol_tank</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_loss_low&#39;</span><span class="p">]]</span>
            <span class="n">Q_loss_upper_sol_tank</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_loss_up&#39;</span><span class="p">]]</span>
            <span class="n">Q_del_sol_tank</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_tank&#39;</span><span class="p">]]</span>
            <span class="n">Q_unmet_sol_tank</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet_tank&#39;</span><span class="p">]]</span>
            <span class="n">Q_dump_sol_tank</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dump&#39;</span><span class="p">]]</span>

            <span class="c1"># tank temperatures and set temperature</span>
            <span class="n">T_upper_sol_tank</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_tank_up&#39;</span><span class="p">]]</span>
            <span class="n">T_lower_sol_tank</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_tank_low&#39;</span><span class="p">]]</span>
            <span class="n">T_set</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_set&#39;</span><span class="p">]]</span>

            <span class="c1"># distribution system</span>
            <span class="n">dT_dist_loss</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;dt_dist&#39;</span><span class="p">]]</span>
            <span class="n">Q_dist_loss</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dist_loss&#39;</span><span class="p">]]</span>
            <span class="n">Q_pump_on_fraction</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;flow_on_frac&#39;</span><span class="p">]]</span>

        <span class="c1"># simulate backup heater and assign household level gas</span>
        <span class="c1"># consumption</span>
        <span class="k">if</span> <span class="n">backup</span> <span class="o">==</span> <span class="s1">&#39;gas&#39;</span><span class="p">:</span>
            <span class="n">backup_proj_total</span><span class="p">,</span> <span class="n">backup_ts_proj</span><span class="p">,</span> <span class="n">backup_ts_cons</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_gas_instantaneous_backup</span><span class="p">(</span>
                    <span class="n">Q_unmet_sol_tank</span><span class="p">,</span>
                    <span class="n">Q_dist_loss</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">backup</span> <span class="o">==</span> <span class="s1">&#39;retrofit&#39;</span><span class="p">:</span>
            <span class="n">backup_proj_total</span><span class="p">,</span> <span class="n">backup_ts_proj</span><span class="p">,</span> <span class="n">backup_ts_cons</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_gas_tank_backup</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">T_upper_sol_tank</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">])</span> <span class="o">-</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dT_dist_loss</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">])),</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">T_upper_sol_tank</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Backup types supported are gas or retrofit. &#39;</span>\
                  <span class="s1">&#39;Please provide one of the supported types.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1"># Please be aware that outputs in step (ts + 1) are results</span>
        <span class="c1"># for the inputs in step ts</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_dem</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem_tot&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_dem_with_dist_loss</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem_balance&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">q_dem_balance</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_sol&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_coil_sol_tank</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_loss_low&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_loss_lower_sol_tank</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_loss_up&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_loss_upper_sol_tank</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_tank&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_del_sol_tank</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet_tank&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_unmet_sol_tank</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dump&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_dump_sol_tank</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_ovrcool_tank&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_ovrcool_sol_tank</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_tank_up&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">T_upper_sol_tank</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_tank_low&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">T_lower_sol_tank</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_coil_out&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">T_coil_out</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_set&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">T_set</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;dt_dist&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dT_dist_loss</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dist_loss&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_dist_loss</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dist_loss_at_bckp&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
            <span class="n">Q_dist_loss</span><span class="p">,</span>
            <span class="n">Q_unmet_sol_tank</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Q_unmet_sol_tank</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dist_loss_at_bckp_sum&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
            <span class="n">Q_dist_loss</span><span class="p">,</span>
            <span class="n">Q_unmet_sol_tank</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Q_unmet_sol_tank</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">it_is_summer</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dist_loss_at_bckp_win&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
            <span class="n">Q_dist_loss</span><span class="p">,</span>
            <span class="n">Q_unmet_sol_tank</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Q_unmet_sol_tank</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">it_is_winter</span>

        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">backup_ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]]</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">backup_ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">backup_ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s&#39;</span><span class="p">]]</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">backup_ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w&#39;</span><span class="p">]]</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_no_dist&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">backup_ts_proj</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_no_dist&#39;</span><span class="p">]]</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s_no_dist&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">backup_ts_proj</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s_no_dist&#39;</span><span class="p">]]</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w_no_dist&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">backup_ts_proj</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w_no_dist&#39;</span><span class="p">]]</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">backup_ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]]</span>

        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q_del_sol_tank</span> <span class="o">+</span>
            <span class="n">backup_ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]])</span>

        <span class="c1"># store timestep weather and water main inputs</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;t_amb&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_amb</span><span class="p">)</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;t_main&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_main</span><span class="p">)</span>
        <span class="c1"># store load</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;proj_load&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">)</span>

        <span class="c1"># get average temperatures and total heat rates</span>
        <span class="n">t_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ts_res</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;Temperature&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>
        <span class="c1"># all other columns contain timestep heat rate</span>
        <span class="n">q_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ts_res</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">t_columns</span><span class="p">))]</span>

        <span class="c1"># project results</span>
        <span class="n">proj_total</span> <span class="o">=</span> <span class="n">ts_res</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">proj_total</span><span class="p">[</span><span class="n">t_columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts_res</span><span class="p">[</span><span class="n">t_columns</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;proj_load&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;proj_load&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">round</span><span class="p">(</span><span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]],</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> \
            <span class="nb">round</span><span class="p">(</span><span class="n">backup_proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]],</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Check project output of the backup - timestep &#39;</span>\
                  <span class="s1">&#39;sum preformed in this method and the total are &#39;</span>\
                  <span class="s1">&#39;not equal.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="c1"># household results (annual quantities split according</span>
        <span class="c1"># to individual loads)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">Q_dem</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">*</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">Q_del_sol_tank</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">+</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet_tank&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">*</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">Q_unmet_sol_tank</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_tank&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">*</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">Q_del_sol_tank</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dist_loss&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">*</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">Q_dist_loss</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dist_loss_at_bckp&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">*</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">ts_res</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dist_loss_at_bckp&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dist_loss_at_bckp_win&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">*</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">ts_res</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dist_loss_at_bckp_win&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dist_loss_at_bckp_sum&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">*</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">ts_res</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dist_loss_at_bckp_sum&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>

        <span class="c1"># Calculate pump electricity consumption</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">community</span><span class="p">:</span>
            <span class="n">dist_pump_on_timestep_frac</span> <span class="o">=</span> <span class="n">Q_pump_on_fraction</span> <span class="o">*</span> <span class="mf">1.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># single households do not require</span>
            <span class="c1"># a distribution pump due to the</span>
            <span class="c1"># water main pressure</span>
            <span class="n">dist_pump_on_timestep_frac</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">pump_ts_el_use</span><span class="p">,</span> <span class="n">pump_el_use</span><span class="p">,</span> <span class="n">pump_op_hour</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_pump_energy_use</span><span class="p">(</span>
            <span class="n">dist_pump_on_timestep_frac</span><span class="o">=</span><span class="n">dist_pump_on_timestep_frac</span><span class="p">,</span>
            <span class="n">gain_from_collector</span><span class="o">=</span><span class="n">Q_coil_sol_tank</span><span class="p">)</span>

        <span class="c1"># Store project level electricity consumption</span>
        <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pump_el_use</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
        <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use_s&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pump_ts_el_use</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">it_is_summer</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use_w&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pump_ts_el_use</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">it_is_winter</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Assign household level electricity consumption</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_utility</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use&#39;</span><span class="p">]],</span>
            <span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use&#39;</span><span class="p">],</span>
            <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;occ&#39;</span><span class="p">],</span>
            <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_utility</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use_s&#39;</span><span class="p">]],</span>
            <span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use_s&#39;</span><span class="p">],</span>
            <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;occ&#39;</span><span class="p">],</span>
            <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_utility</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use_w&#39;</span><span class="p">]],</span>
            <span class="n">var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use_w&#39;</span><span class="p">],</span>
            <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;occ&#39;</span><span class="p">],</span>
            <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># project level solar fraction</span>
        <span class="n">sol_fra</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">sol_fra</span><span class="p">[</span><span class="s1">&#39;annual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]]</span> <span class="o">-</span>
            <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]])</span> <span class="o">/</span> <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]]</span>

        <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;sol_fra&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sol_fra</span><span class="p">[</span><span class="s1">&#39;annual&#39;</span><span class="p">]</span>

        <span class="c1"># get annual and monthly project level solar fractions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">month</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sol_fra_hourly</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="n">sol_fra_hourly</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">month</span>
            <span class="n">sol_fra_hourly</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">season</span>
            <span class="n">sol_fra_hourly</span><span class="p">[</span><span class="s1">&#39;hourly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]]</span> <span class="o">-</span>
                <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]])</span> <span class="o">/</span> <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]]</span>

            <span class="n">sol_fra</span><span class="p">[</span><span class="s1">&#39;monthly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_fra_hourly</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;hourly&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;month_sol_fra&#39;</span><span class="p">]})</span>

            <span class="n">sol_fra</span><span class="p">[</span><span class="s1">&#39;seasonal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_fra_hourly</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;hourly&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;season_sol_fra&#39;</span><span class="p">]})</span>

            <span class="n">sol_fra</span><span class="p">[</span><span class="s1">&#39;seasonal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_fra</span><span class="p">[</span><span class="s1">&#39;seasonal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">])</span>

        <span class="c1"># household level solar fraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;sol_fra&#39;</span><span class="p">]]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]]</span> <span class="o">-</span>
                    <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]]))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ann_cons_fract&#39;</span><span class="p">]</span> <span class="o">*</span>
                 <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]]),</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># check annual tank balance</span>
        <span class="n">_in</span> <span class="o">=</span> <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_sol&#39;</span><span class="p">]]</span>

        <span class="n">_outs</span> <span class="o">=</span> <span class="p">(</span><span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_tank&#39;</span><span class="p">]]</span> <span class="o">+</span>
                 <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dump&#39;</span><span class="p">]]</span> <span class="o">+</span>
                 <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_loss_up&#39;</span><span class="p">]]</span> <span class="o">+</span>
                 <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_loss_low&#39;</span><span class="p">]]</span> <span class="o">-</span>
                 <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_ovrcool_tank&#39;</span><span class="p">]])</span>

        <span class="n">rel_err</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">_in</span> <span class="o">-</span> <span class="n">_outs</span><span class="p">)</span> <span class="o">/</span> <span class="n">_in</span>

        <span class="k">if</span> <span class="n">rel_err</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">01</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Solar tank balance error is </span><span class="si">{}</span><span class="s1">.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rel_err</span><span class="p">))</span>

        <span class="c1"># time indices for timestep results only</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">month</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">season</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">day</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;hour&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hour</span>

        <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;max_load&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">UnitConv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_max</span><span class="p">)</span><span class="o">.</span><span class="n">m3_gal</span><span class="p">(</span>
            <span class="n">unit_in</span><span class="o">=</span><span class="s1">&#39;m3&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">proj_total</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span>
            <span class="n">proj_total</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="n">sol_fra</span><span class="p">,</span> <span class="n">pump_el_use</span><span class="p">,</span>
            <span class="n">pump_op_hour</span><span class="p">,</span> <span class="n">ts_res</span><span class="p">,</span>
            <span class="n">backup_ts_cons</span><span class="p">,</span> <span class="n">rel_err</span><span class="p">]</span></div>


<div class="viewcode-block" id="System.solar_electric"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.models.System.solar_electric">[docs]</a>    <span class="k">def</span> <span class="nf">solar_electric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="s1">&#39;electric&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Connects the components of the</span>
<span class="sd">        solar electric system and enables simulation.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            backup: string</span>
<span class="sd">                electric - instantaneous WHs (new installations)</span>

<span class="sd">        Returns:</span>

<span class="sd">            sys_en_use: dict</span>
<span class="sd">                System level energy use for the analysis period:</span>
<span class="sd">                &#39;electricity&#39;, Wh</span>

<span class="sd">            sol_fra: dict</span>
<span class="sd">                Solar fraction. Keys: &#39;annual&#39;, &#39;monthly&#39;</span>

<span class="sd">            ts_res: pd df</span>
<span class="sd">                Colums populated with state variable timeseries, such as</span>
<span class="sd">                average timstep heat rates and temperatures</span>

<span class="sd">            res: dict</span>
<span class="sd">                Summarizes ts_res. Any heat rates are summed, while the</span>
<span class="sd">                temperatures are averaged for the analysis period</span>
<span class="sd">                (usually one year)</span>

<span class="sd">            el_use: dict</span>
<span class="sd">                Electricity use broken into end uses</span>
<span class="sd">                &#39;dist_pump&#39; - distribution pump, if present</span>

<span class="sd">            rel_err: float</span>
<span class="sd">                Balancing error due to limitations of finite</span>
<span class="sd">                timestep averaging. More precisely, due to</span>
<span class="sd">                selecting minimum tank temperature</span>
<span class="sd">                as the lower between the water main and the ambient.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># initiate a dataframe with hourly results</span>
        <span class="n">ts_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># components</span>
        <span class="n">converters</span> <span class="o">=</span> <span class="n">Converter</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_params</span><span class="p">,</span>
            <span class="n">weather</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="p">,</span>
            <span class="n">sizes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_sizes</span><span class="p">)</span>

        <span class="n">hp_tank</span> <span class="o">=</span> <span class="n">Storage</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_params</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_sizes</span><span class="p">,</span>
            <span class="n">timestep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;hp_tank&#39;</span><span class="p">)</span>

        <span class="c1"># Initiate arrays to hold the results during calculation</span>
        <span class="c1"># (improved performance with arrays, assigning to df post-calc)</span>

        <span class="c1"># Heat pump electricity usage</span>
        <span class="n">P_hp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Photovoltaic gain (before and after inverter)</span>
        <span class="n">P_pv_ac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">P_pv_dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Electric power generated by PV, usages</span>
        <span class="n">P_pv_to_hp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">P_pv_after_hp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Electric power available for feeding back to grid or</span>
        <span class="c1"># powering e.g. household appliances</span>
        <span class="n">P_surplus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># demand heat rate</span>
        <span class="n">Q_dem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Q_dem_with_dist_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">q_dem_balance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># input balance on the heat pump tank</span>
        <span class="n">Q_hp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Q_loss_lower_hp_tank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Q_loss_upper_hp_tank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># output balance on the heat pump tank</span>
        <span class="n">Q_del_hp_tank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Q_unmet_hp_tank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Q_dump_hp_tank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Q_ovrcool_hp_tank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># tank temperature states</span>
        <span class="n">T_upper_hp_tank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">T_lower_hp_tank</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># set values for the initial timestep</span>
        <span class="n">T_upper_hp_tank</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_main</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T_lower_hp_tank</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_main</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># ambient air and main water temperatures</span>
        <span class="n">T_main</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">T_wet_bulb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">T_amb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># set initial values</span>
        <span class="n">T_main</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_main</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T_wet_bulb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_wet_bulb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T_amb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_amb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># intial HP status</span>
        <span class="n">hp_status</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">dt_hist</span> <span class="o">=</span> <span class="mf">5.</span>

        <span class="n">T_limit</span> <span class="o">=</span> <span class="n">hp_tank</span><span class="o">.</span><span class="n">T_max</span>

        <span class="k">for</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span><span class="p">):</span>

            <span class="c1"># Use upper tank temperature, since this will be tapped and has</span>
            <span class="c1"># to meet T_draw_set</span>
            <span class="n">T_tank</span> <span class="o">=</span> <span class="n">T_upper_hp_tank</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span>

            <span class="c1"># hp uses temperature hysteresis as on/off control</span>
            <span class="k">if</span> <span class="p">(((</span><span class="n">hp_status</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">T_tank</span> <span class="o">&lt;</span> <span class="n">T_limit</span><span class="p">))</span> <span class="ow">or</span>
                <span class="p">((</span><span class="ow">not</span> <span class="n">hp_status</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">T_tank</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">T_limit</span> <span class="o">-</span> <span class="n">dt_hist</span><span class="p">)))):</span>

                <span class="n">hp_res</span> <span class="o">=</span> <span class="n">converters</span><span class="o">.</span><span class="n">heat_pump</span><span class="p">(</span>
                    <span class="n">T_wet_bulb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t_wet_bulb</span><span class="p">[</span><span class="n">ts</span><span class="p">],</span>
                    <span class="n">T_tank</span><span class="o">=</span><span class="n">T_tank</span><span class="p">)</span>

                <span class="c1"># enable heat pump (or keep it on)</span>
                <span class="n">hp_status</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Set heat pump results to zero</span>
                <span class="n">hp_res</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;heat_cap&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
                          <span class="s1">&#39;el_use&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
                          <span class="s1">&#39;cop&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">}</span>

                <span class="c1"># disable heat pump (or leave it off)</span>
                <span class="n">hp_status</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># hp heat gain to the tank (updated in</span>
            <span class="c1"># each timestep, recorded later as</span>
            <span class="c1"># output of the hp tank)</span>
            <span class="n">Q_hp_cap</span> <span class="o">=</span> <span class="n">hp_res</span><span class="p">[</span><span class="s1">&#39;heat_cap&#39;</span><span class="p">]</span>

            <span class="c1"># electricity use of the heat pump</span>
            <span class="n">P_hp</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span> <span class="o">=</span> <span class="n">hp_res</span><span class="p">[</span><span class="s1">&#39;el_use&#39;</span><span class="p">]</span>

            <span class="n">pv_res</span> <span class="o">=</span> <span class="n">converters</span><span class="o">.</span><span class="n">photovoltaic</span><span class="p">(</span>
                <span class="n">use_p_peak</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">inc_rad</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inc_rad</span><span class="p">[</span><span class="n">ts</span><span class="p">])</span>

            <span class="c1"># Electric power produced by photovoltaic module</span>
            <span class="n">P_pv_ac</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv_res</span><span class="p">[</span><span class="s1">&#39;ac&#39;</span><span class="p">]</span>
            <span class="n">P_pv_dc</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv_res</span><span class="p">[</span><span class="s1">&#39;dc&#39;</span><span class="p">]</span>

            <span class="c1"># Calculate electric power generated by PV used for supplying</span>
            <span class="c1"># the HP</span>
            <span class="n">P_pv_to_hp</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">P_hp</span><span class="p">[</span><span class="n">ts</span><span class="p">],</span> <span class="n">P_pv_ac</span><span class="p">[</span><span class="n">ts</span><span class="p">])</span>

            <span class="c1"># Calculate amount of electricity available for other</span>
            <span class="c1"># applications</span>
            <span class="n">P_pv_after_hp</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">P_pv_ac</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span> <span class="o">-</span> <span class="n">P_hp</span><span class="p">[</span><span class="n">ts</span><span class="p">]),</span> <span class="mf">0.</span><span class="p">)</span>

            <span class="n">sto_res</span> <span class="o">=</span> <span class="n">hp_tank</span><span class="o">.</span><span class="n">thermal_tank</span><span class="p">(</span>
                <span class="n">pre_T_amb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t_amb</span><span class="p">[</span><span class="n">ts</span><span class="p">],</span>
                <span class="n">pre_T_feed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t_main</span><span class="p">[</span><span class="n">ts</span><span class="p">],</span>
                <span class="n">pre_T_upper</span><span class="o">=</span><span class="n">T_upper_hp_tank</span><span class="p">[</span><span class="n">ts</span><span class="p">],</span>
                <span class="n">pre_T_lower</span><span class="o">=</span><span class="n">T_lower_hp_tank</span><span class="p">[</span><span class="n">ts</span><span class="p">],</span>
                <span class="n">pre_V_tap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">[</span><span class="n">ts</span><span class="p">],</span>
                <span class="n">pre_Q_in</span><span class="o">=</span><span class="n">Q_hp_cap</span><span class="p">,</span>
                <span class="n">max_V_tap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load_max</span><span class="p">)</span>

            <span class="c1"># demand heat rate</span>
            <span class="n">Q_dem</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]]</span>
            <span class="n">Q_dem_with_dist_loss</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem_tot&#39;</span><span class="p">]]</span>
            <span class="n">q_dem_balance</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem_balance&#39;</span><span class="p">]]</span>

            <span class="c1"># heat pump tank heat sources</span>
            <span class="n">Q_hp</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_hp&#39;</span><span class="p">]]</span>
            <span class="n">Q_ovrcool_hp_tank</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_ovrcool_tank&#39;</span><span class="p">]]</span>

            <span class="c1"># heat pump tank heat sinks</span>
            <span class="n">Q_loss_lower_hp_tank</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_loss_low&#39;</span><span class="p">]]</span>
            <span class="n">Q_loss_upper_hp_tank</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_loss_up&#39;</span><span class="p">]]</span>
            <span class="n">Q_del_hp_tank</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_tank&#39;</span><span class="p">]]</span>
            <span class="n">Q_unmet_hp_tank</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet_tank&#39;</span><span class="p">]]</span>
            <span class="n">Q_dump_hp_tank</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dump&#39;</span><span class="p">]]</span>

            <span class="c1"># resulting temperatures in the heat pump tank</span>
            <span class="n">T_upper_hp_tank</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_tank_up&#39;</span><span class="p">]]</span>
            <span class="n">T_lower_hp_tank</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sto_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_tank_low&#39;</span><span class="p">]]</span>

            <span class="c1"># set ambient air and main water temperatures</span>
            <span class="n">T_main</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_main</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span>
            <span class="n">T_wet_bulb</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_wet_bulb</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span>
            <span class="n">T_amb</span><span class="p">[</span><span class="n">ts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_amb</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span>

        <span class="c1"># simulate backup heater and assign household level</span>
        <span class="c1"># electricity consumption</span>
        <span class="k">if</span> <span class="n">backup</span> <span class="o">==</span> <span class="s1">&#39;electric&#39;</span><span class="p">:</span>
            <span class="n">backup_proj_total</span><span class="p">,</span> <span class="n">backup_ts_proj</span><span class="p">,</span> \
            <span class="n">backup_ts_cons</span><span class="p">,</span> <span class="n">P_pv_after_bckp</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_electric_instantaneous_backup</span><span class="p">(</span>
                    <span class="n">Q_unmet_hp_tank</span><span class="p">,</span>
                    <span class="n">P_pv_after_hp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Backup types supported are: </span><span class="se">\&#39;</span><span class="s1">electric</span><span class="se">\&#39;</span><span class="s1">. &#39;</span>\
                  <span class="s1">&#39;Please provide one of the supported types.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1"># store timestep results in a dataframe</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_dem</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_hp&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_hp</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">backup_ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]]</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_loss_low&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_loss_lower_hp_tank</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_loss_up&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_loss_upper_hp_tank</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_tank&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_del_hp_tank</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet_tank&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_unmet_hp_tank</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dump&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_dump_hp_tank</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_ovrcool_tank&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_ovrcool_hp_tank</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_tank_up&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">T_upper_hp_tank</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_tank_low&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">T_lower_hp_tank</span>
        <span class="c1"># PV generated electricity (AC)</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;p_pv_ac&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">P_pv_ac</span>
        <span class="c1"># PV generated electricity (DC)</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;p_pv_dc&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">P_pv_dc</span>

        <span class="c1"># total heat gain (heat pump and electric resistance)</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Q_hp</span> <span class="o">+</span> <span class="n">backup_ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]]</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">backup_ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]]</span>

        <span class="c1"># Usage of electric power generated by PV</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;p_pv_to_hp&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">P_pv_to_hp</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;p_pv_to_el_res&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">P_pv_after_bckp</span><span class="p">[</span><span class="s1">&#39;used_for_bckp&#39;</span><span class="p">]</span>

        <span class="c1"># Electricity usage (from grid and PV)</span>
        <span class="c1"># Heat Pump</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;p_hp_el_use&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">P_hp</span>
        <span class="c1"># Electric Resistance</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;p_el_res_use&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">backup_ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;grs_el_use&#39;</span><span class="p">]]</span>

        <span class="c1"># also include the water and air temperatures in the results</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_main&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">T_main</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_amb&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">T_amb</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_wet_bulb&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">T_wet_bulb</span>

        <span class="c1"># get average temperatures and total heat rates</span>
        <span class="n">t_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ts_res</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;Temperature&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>
        <span class="c1"># all other columns contain timestep heat rate</span>
        <span class="n">q_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ts_res</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">t_columns</span><span class="p">))]</span>

        <span class="c1"># project results</span>
        <span class="n">proj_total</span> <span class="o">=</span> <span class="n">ts_res</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">proj_total</span><span class="p">[</span><span class="n">t_columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts_res</span><span class="p">[</span><span class="n">t_columns</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># household results (annual quantities split according</span>
        <span class="c1"># to individual loads)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">Q_dem</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">Q_del_hp_tank</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">+</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet_tank&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">Q_unmet_hp_tank</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_tank&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">Q_del_hp_tank</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="c1"># Calculate pump electricity use</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">community</span><span class="p">:</span>
            <span class="n">dist_pump_on_timestep_frac</span> <span class="o">=</span> <span class="n">Q_del_hp_tank</span> <span class="o">+</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># single households do not require</span>
            <span class="c1"># a distribution pump due to the</span>
            <span class="c1"># water main pressure</span>
            <span class="n">dist_pump_on_timestep_frac</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">pump_ts_el_use</span><span class="p">,</span> <span class="n">pump_el_use</span><span class="p">,</span> <span class="n">pump_op_hour</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_pump_energy_use</span><span class="p">(</span>
                <span class="n">dist_pump_on_timestep_frac</span><span class="o">=</span><span class="n">dist_pump_on_timestep_frac</span><span class="p">)</span>

        <span class="c1"># if there is any PV power left, use it for the pumps</span>
        <span class="n">pump_ts_el_use_after_pv</span> <span class="o">=</span> <span class="p">(</span><span class="n">pump_ts_el_use</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">-</span>
            <span class="n">P_pv_after_bckp</span><span class="p">[</span><span class="s1">&#39;rem_after&#39;</span><span class="p">])</span>
        <span class="n">pump_ts_el_use_after_pv</span><span class="p">[</span><span class="n">pump_ts_el_use_after_pv</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="n">pump_el_use</span><span class="p">[</span><span class="s1">&#39;after_pv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pump_ts_el_use_after_pv</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Distribute pump el. use onto households and add to</span>
        <span class="c1"># total electricity use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_utility</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">pump_el_use</span><span class="p">[</span><span class="s1">&#39;after_pv&#39;</span><span class="p">],</span>
            <span class="n">var</span><span class="o">=</span><span class="s1">&#39;pump_el_use&#39;</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;occ&#39;</span><span class="p">],</span>
            <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="s1">&#39;pump_el_use&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pump_el_use&#39;</span><span class="p">])</span>

        <span class="c1"># Total electricity use</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;grs_el_use&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;p_hp_el_use&#39;</span><span class="p">]]</span> <span class="o">+</span>
                                        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;p_el_res_use&#39;</span><span class="p">]]</span> <span class="o">+</span>
                                        <span class="n">pump_el_use</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">])</span>

        <span class="c1"># Electricity available after hp, backup heater and pumps</span>
        <span class="n">P_surplus</span> <span class="o">=</span> <span class="n">P_pv_after_bckp</span><span class="p">[</span><span class="s1">&#39;rem_after&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">pump_ts_el_use</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
        <span class="n">P_surplus</span><span class="p">[</span><span class="n">P_surplus</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">ts_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;p_surplus&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">P_surplus</span>

        <span class="c1"># project level solar fraction (excludes pumping energy)</span>
        <span class="n">sol_fra</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># Calculate the fraction of HP el. use that came from the PV</span>

        <span class="c1"># annual</span>
        <span class="n">fraction_pv_to_hp</span> <span class="o">=</span> <span class="p">(</span><span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;p_pv_to_hp&#39;</span><span class="p">]]</span> <span class="o">/</span>
                             <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;p_hp_el_use&#39;</span><span class="p">]])</span>

        <span class="c1"># annual</span>
        <span class="n">fraction_pv_to_el_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;p_pv_to_el_res&#39;</span><span class="p">]]</span> <span class="o">/</span>
                                 <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;p_el_res_use&#39;</span><span class="p">]])</span>
        <span class="c1"># for each timestep</span>

        <span class="c1"># Calculate solar fraction between generated PV power and</span>
        <span class="c1"># total electricity use</span>
        <span class="n">sol_fra</span><span class="p">[</span><span class="s1">&#39;annual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_hp&#39;</span><span class="p">]]</span> <span class="o">*</span>
            <span class="n">fraction_pv_to_hp</span> <span class="o">+</span>
            <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="n">fraction_pv_to_el_res</span><span class="p">)</span> <span class="o">/</span>
            <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]])</span>

        <span class="c1"># check annual tank balance</span>
        <span class="n">_in</span> <span class="o">=</span> <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_hp&#39;</span><span class="p">]]</span>

        <span class="n">_outs</span> <span class="o">=</span> <span class="p">(</span><span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_tank&#39;</span><span class="p">]]</span> <span class="o">+</span>
                 <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dump&#39;</span><span class="p">]]</span> <span class="o">+</span>
                 <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_loss_up&#39;</span><span class="p">]]</span> <span class="o">+</span>
                 <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_loss_low&#39;</span><span class="p">]]</span> <span class="o">-</span>
                 <span class="n">proj_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_ovrcool_tank&#39;</span><span class="p">]])</span>

        <span class="n">rel_err</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">_in</span> <span class="o">-</span> <span class="n">_outs</span><span class="p">)</span> <span class="o">/</span> <span class="n">_in</span>

        <span class="k">if</span> <span class="n">rel_err</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">01</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Heat pump tank balance error is </span><span class="si">{}</span><span class="s1">.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rel_err</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">,</span> <span class="n">proj_total</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="p">[</span>
            <span class="n">proj_total</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="n">sol_fra</span><span class="p">,</span> <span class="n">pump_el_use</span><span class="p">,</span>
            <span class="n">pump_op_hour</span><span class="p">,</span> <span class="n">ts_res</span><span class="p">,</span> <span class="n">rel_err</span><span class="p">]</span></div>

<div class="viewcode-block" id="System.conventional_gas_tank"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.models.System.conventional_gas_tank">[docs]</a>    <span class="k">def</span> <span class="nf">conventional_gas_tank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Basecase conventional gas tank water heater.</span>
<span class="sd">        Make sure to size the tank according to the recommended</span>
<span class="sd">        sizing rules, since the WHAM model does not apply to</span>
<span class="sd">        tanks that are not appropriately sized.</span>

<span class="sd">        Returns:</span>

<span class="sd">            ts_proj: dict of arrays, W</span>
<span class="sd">                Heat:</span>

<span class="sd">                * self.r[&#39;q_del&#39;]: delivered</span>
<span class="sd">                * self.r[&#39;gas_use&#39;]: gas consumed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># components</span>
        <span class="n">heater</span> <span class="o">=</span> <span class="n">Storage</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_params</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_sizes</span><span class="p">,</span>
            <span class="n">timestep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;wham_tank&#39;</span><span class="p">,</span>
            <span class="n">log_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="c1"># indoor air temperature is 291.48 K</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">heater</span><span class="o">.</span><span class="n">gas_tank_wh</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_main</span><span class="p">,</span>
            <span class="n">T_amb</span><span class="o">=</span><span class="mf">291.48</span><span class="p">)</span>

        <span class="c1"># household/project level timestep results</span>
        <span class="n">ts_proj</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del&#39;</span><span class="p">]:</span> <span class="n">res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del&#39;</span><span class="p">]],</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]:</span> <span class="n">res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]],</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_no_dist&#39;</span><span class="p">]:</span> <span class="n">res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]],</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]:</span> <span class="n">res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]]}</span>

        <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">season</span>

        <span class="c1"># household/project level analysis period results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use_s&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use_w&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">=</span> \
            <span class="n">res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">it_is_winter</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">it_is_summer</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

        <span class="c1"># these are just placeholders for consistency</span>
        <span class="c1"># the model considers only additional distribution piping</span>
        <span class="c1"># in case of a solar thermal system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_no_dist&#39;</span><span class="p">]]</span> <span class="o">=</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s_no_dist&#39;</span><span class="p">]]</span> <span class="o">=</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s&#39;</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w_no_dist&#39;</span><span class="p">]]</span> <span class="o">=</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w&#39;</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del&#39;</span><span class="p">]]</span> <span class="o">=</span>\
            <span class="n">res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]]</span> <span class="o">=</span>\
            <span class="n">res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

        <span class="c1"># zero by WHAM model definition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dump&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dist_loss&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dist_loss_at_bckp&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dist_loss_at_bckp_sum&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dist_loss_at_bckp_win&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;sol_fra&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;max_load&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">UnitConv</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_max</span><span class="p">)</span><span class="o">.</span><span class="n">m3_gal</span><span class="p">(</span><span class="n">unit_in</span><span class="o">=</span><span class="s1">&#39;m3&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">ts_proj</span></div>

<div class="viewcode-block" id="System.simulate"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.models.System.simulate">[docs]</a>    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;gas_tank_wh&#39;</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Runs a 8760. hourly simulation of the</span>
<span class="sd">            provided system type.</span>

<span class="sd">            Parameters:</span>

<span class="sd">                type: string</span>
<span class="sd">                    * &#39;gas_tank_wh&#39;</span>
<span class="sd">                    * &#39;solar_thermal_retrofit&#39;</span>
<span class="sd">                      (gas tank backup at each household)</span>
<span class="sd">                    * &#39;solar_thermal_new&#39;</span>
<span class="sd">                      (gas tankless backup at each household)</span>
<span class="sd">                    * &#39;solar_electric&#39;</span>

<span class="sd">            Returns:</span>

<span class="sd">                en_use: dict</span>
<span class="sd">                    Total energy use for the analysis period:</span>
<span class="sd">                    </span>
<span class="sd">                    * &#39;gas&#39;, Wh</span>
<span class="sd">                    * &#39;electricity&#39;, Wh</span>

<span class="sd">                sys_res: list</span>
<span class="sd">                    List containing detailed system level</span>
<span class="sd">                    output. See dedicated methods for details</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># idealized instantaneous backup (type = see db for system names)</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;solar_thermal_new&#39;</span><span class="p">:</span>
                <span class="n">cons_total</span><span class="p">,</span> <span class="n">proj_total</span><span class="p">,</span> <span class="n">sys_res</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">solar_thermal</span><span class="p">(</span><span class="n">backup</span><span class="o">=</span><span class="s1">&#39;gas&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;solar_electric&#39;</span><span class="p">:</span>
                <span class="n">cons_total</span><span class="p">,</span> <span class="n">proj_total</span><span class="p">,</span> <span class="n">sys_res</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">solar_electric</span><span class="p">()</span>

            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;solar_thermal_retrofit&#39;</span><span class="p">:</span>
                <span class="n">cons_total</span><span class="p">,</span> <span class="n">proj_total</span><span class="p">,</span> <span class="n">sys_res</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">solar_thermal</span><span class="p">(</span><span class="n">backup</span><span class="o">=</span><span class="s1">&#39;retrofit&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;gas_tank_wh&#39;</span><span class="p">:</span>
                <span class="n">cons_total</span><span class="p">,</span> <span class="n">sys_res</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">conventional_gas_tank</span><span class="p">()</span>
                <span class="n">proj_total</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">sol_fra</span> <span class="o">=</span> <span class="mf">0.</span>

            <span class="k">return</span> <span class="n">cons_total</span><span class="p">,</span> <span class="n">proj_total</span><span class="p">,</span> <span class="n">sys_res</span></div>

    <span class="k">def</span> <span class="nf">_gas_instantaneous_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Q_unmet_sol_tank</span><span class="p">,</span>
                                  <span class="n">Q_dist_loss</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulates the performance of each individual household</span>
<span class="sd">        backup based on their hot water end-use load</span>
<span class="sd">        profile and the load unmet by the community solar system.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            Q_unmet_sol_tank: array</span>
<span class="sd">                Unmet demand after the solar tank (set load for the</span>
<span class="sd">                backup)</span>

<span class="sd">            Q_dist_loss: array</span>
<span class="sd">                Distribution losses</span>

<span class="sd">        Returns:</span>

<span class="sd">            total_proj: pd df</span>
<span class="sd">                Project level backup energy use</span>
<span class="sd">                and heat rates.</span>

<span class="sd">            ts_proj: dict</span>
<span class="sd">                Timestep project level results for</span>
<span class="sd">                energy use (gas consumed) and heat rates</span>
<span class="sd">                (delivered, unmet)</span>

<span class="sd">            ts_cons: dict of dicts</span>
<span class="sd">                Timestep household level results for energy uses [W],</span>
<span class="sd">                and heat rates [W].</span>

<span class="sd">            Updates `self.cons_total` with the backup simulation</span>
<span class="sd">            energy use and heat rates results.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># project level backup delivered, gas use and unmet</span>
        <span class="n">ts_proj</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_no_dist&#39;</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}</span>

        <span class="n">ts_cons</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># Distribution losses when the backup is on. The</span>
        <span class="c1"># actual loss covered by the backup is distributed over</span>
        <span class="c1"># individual households in the loop below</span>
        <span class="n">Q_dist_loss_when_backup_on</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q_dist_loss</span> <span class="o">*</span>
            <span class="p">(</span><span class="n">Q_unmet_sol_tank</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">))</span>

        <span class="n">Q_unmet_without_dist_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q_unmet_sol_tank</span> <span class="o">-</span>
            <span class="n">Q_dist_loss_when_backup_on</span><span class="p">)</span>

        <span class="c1"># distribution loss may be larger than</span>
        <span class="c1"># the backup demand (this occurs when a part of</span>
        <span class="c1"># the loss got covered by the solar source),</span>
        <span class="c1"># so impose zero as lower limit</span>
        <span class="n">Q_unmet_without_dist_loss</span><span class="p">[</span>
            <span class="n">Q_unmet_without_dist_loss</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="k">for</span> <span class="n">cons_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="c1"># get the fraction of the remaining load</span>
            <span class="c1"># pertaining to a single household, which should</span>
            <span class="c1"># be met by that household&#39;s backup</span>
            <span class="n">Q_unmet_sol_tank_ind_cons</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q_unmet_sol_tank</span> <span class="o">*</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">Q_unmet_sol_tank_ind_cons_no_dist_loss</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">Q_unmet_without_dist_loss</span> <span class="o">*</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_sizes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">backup_sizes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">]]]</span>

            <span class="n">ind_backup</span> <span class="o">=</span> <span class="n">Converter</span><span class="p">(</span>
                <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backup_params</span><span class="p">,</span>
                <span class="n">weather</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="p">,</span>
                <span class="n">sizes</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
                <span class="n">log_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

            <span class="n">ind_res</span> <span class="o">=</span> <span class="n">ind_backup</span><span class="o">.</span><span class="n">gas_burner</span><span class="p">(</span>
                <span class="n">Q_unmet_sol_tank_ind_cons</span><span class="p">)</span>

            <span class="n">ind_res_no_dist_loss</span> <span class="o">=</span> <span class="n">ind_backup</span><span class="o">.</span><span class="n">gas_burner</span><span class="p">(</span>
                <span class="n">Q_unmet_sol_tank_ind_cons_no_dist_loss</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ind_res</span><span class="p">:</span>
                <span class="n">ts_proj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ind_res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_no_dist&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="n">ind_res_no_dist_loss</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]])</span>

            <span class="n">ts_cons</span><span class="p">[</span><span class="n">cons_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]:</span> <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]:</span> <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s&#39;</span><span class="p">]:</span> <span class="p">(</span><span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">it_is_summer</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w&#39;</span><span class="p">]:</span> <span class="p">(</span><span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">it_is_winter</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_no_dist&#39;</span><span class="p">]:</span> <span class="n">ind_res_no_dist_loss</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s_no_dist&#39;</span><span class="p">]:</span> <span class="n">ind_res_no_dist_loss</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">it_is_summer</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w_no_dist&#39;</span><span class="p">]:</span> <span class="n">ind_res_no_dist_loss</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">it_is_winter</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]:</span> <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]]}</span>

            <span class="n">ts_cons</span><span class="p">[</span><span class="n">cons_id</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">season</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ind_res</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">it_is_summer</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">it_is_winter</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_no_dist&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ind_res_no_dist_loss</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s_no_dist&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ind_res_no_dist_loss</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">it_is_summer</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w_no_dist&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ind_res_no_dist_loss</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">it_is_winter</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ind_res</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

        <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">it_is_summer</span><span class="p">)</span>

        <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">it_is_winter</span><span class="p">)</span>

        <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s_no_dist&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_no_dist&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">it_is_summer</span><span class="p">)</span>

        <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w_no_dist&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_no_dist&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">it_is_winter</span><span class="p">)</span>

        <span class="n">total_proj</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">ts_proj</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">season</span>

        <span class="k">return</span> <span class="n">total_proj</span><span class="p">,</span> <span class="n">ts_proj</span><span class="p">,</span> <span class="n">ts_cons</span>

    <span class="k">def</span> <span class="nf">_electric_instantaneous_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Q_unmet_tank</span><span class="p">,</span> <span class="n">P_pv</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulates the performance of each individual household</span>
<span class="sd">        backup based on their hot water end-use load</span>
<span class="sd">        profile and the load unmet by the community solar system.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            Q_unmet_tank: array</span>
<span class="sd">                Unmet demand after the solar tank (set load for the</span>
<span class="sd">                backup)</span>

<span class="sd">            P_pv: array</span>
<span class="sd">                PV power available for the backup application</span>
<span class="sd">                Set to None if there is no PV in the system or</span>
<span class="sd">                if PV generated power should not be used</span>
<span class="sd">                to power the electric heater backup</span>

<span class="sd">            total_proj: pd df</span>
<span class="sd">                Project level backup energy use</span>
<span class="sd">                and heat rates.</span>

<span class="sd">            ts_proj: dict</span>
<span class="sd">                Timestep project level results for energy use [W],</span>
<span class="sd">                and delivered heat rate [W].</span>

<span class="sd">            ts_cons: dict of dicts</span>
<span class="sd">                Timestep household level results for energy use [W],</span>
<span class="sd">                and delivered heat rate [W].</span>

<span class="sd">            Updates self.cons_total with the backup simulation</span>
<span class="sd">            energy use and heat rates results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">P_pv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">P_pv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># project level backup delivered, gas use and unmet</span>
        <span class="n">ts_proj</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use&#39;</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;grs_el_use&#39;</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}</span>

        <span class="n">ts_cons</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">cons_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="c1"># get the fraction of the remaining load</span>
            <span class="c1"># pertaining to a single household, which should</span>
            <span class="c1"># be met by that household&#39;s backup</span>
            <span class="n">Q_unmet_tank_ind_cons</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q_unmet_tank</span> <span class="o">*</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># fraction of the PV generated power that can be allocated</span>
            <span class="c1"># to consumer cons_id</span>
            <span class="n">P_pv_ind_cons</span> <span class="o">=</span> <span class="p">(</span><span class="n">P_pv</span> <span class="o">*</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">indiv_load_ratios</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_sizes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">backup_sizes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">]]]</span>

            <span class="n">ind_backup</span> <span class="o">=</span> <span class="n">Converter</span><span class="p">(</span>
                <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backup_params</span><span class="p">,</span>
                <span class="n">weather</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="p">,</span>
                <span class="n">sizes</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>

            <span class="n">ind_res</span> <span class="o">=</span> <span class="n">ind_backup</span><span class="o">.</span><span class="n">electric_resistance</span><span class="p">(</span>
                <span class="n">Q_unmet_tank_ind_cons</span><span class="p">)</span>

            <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;grs_el_use&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="mf">1.</span><span class="p">)</span>

            <span class="c1"># power from PV if possible</span>
            <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;grs_el_use&#39;</span><span class="p">]]</span> <span class="o">-</span> <span class="n">P_pv_ind_cons</span><span class="p">)</span>
            <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use&#39;</span><span class="p">]][</span>
                <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use&#39;</span><span class="p">]]</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ind_res</span><span class="p">:</span>
                <span class="n">ts_proj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ind_res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="n">ts_cons</span><span class="p">[</span><span class="n">cons_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]:</span> <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use&#39;</span><span class="p">]:</span> <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use&#39;</span><span class="p">]],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]:</span> <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]]}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ind_res</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ind_res</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ind_res</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

        <span class="c1"># PV power accounting</span>
        <span class="n">P_pv_bckp</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">P_pv_bckp</span><span class="p">[</span><span class="s1">&#39;rem_after&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_pv</span> <span class="o">-</span> <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;grs_el_use&#39;</span><span class="p">]]</span>
        <span class="n">P_pv_bckp</span><span class="p">[</span><span class="s1">&#39;rem_after&#39;</span><span class="p">][</span><span class="n">P_pv_bckp</span><span class="p">[</span><span class="s1">&#39;rem_after&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="n">P_pv_bckp</span><span class="p">[</span><span class="s1">&#39;used_for_bckp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">P_pv</span> <span class="o">-</span> <span class="n">P_pv_bckp</span><span class="p">[</span><span class="s1">&#39;rem_after&#39;</span><span class="p">]</span>

        <span class="n">total_proj</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">ts_proj</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">total_proj</span><span class="p">,</span> <span class="n">ts_proj</span><span class="p">,</span> <span class="n">ts_cons</span><span class="p">,</span> <span class="n">P_pv_bckp</span>

    <span class="k">def</span> <span class="nf">_gas_tank_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T_feed</span><span class="p">,</span> <span class="n">T_feed_no_loss</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Backup gas tank water heater. Retrofit systems</span>
<span class="sd">        retain the original one.</span>

<span class="sd">        Currently we assume that the outdoor air temperature</span>
<span class="sd">        rarely drives the tank temperature below the water</span>
<span class="sd">        main. If the model is to be applied for colder climates,</span>
<span class="sd">        and the tanks are to be installed outdoors, a valve which</span>
<span class="sd">        switches the backup feed to main in case the feed from the</span>
<span class="sd">        tank is of a lower temperature should be implemented.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            T_feed: array like, K</span>
<span class="sd">                Backup water heater inlet temperature</span>

<span class="sd">            T_feed_no_loss: array like, K</span>
<span class="sd">                Backup water heater inlet temperature</span>
<span class="sd">                assuming no temperature drop in the</span>
<span class="sd">                distribution system (adiabatic pipe)</span>

<span class="sd">        Returns:</span>

<span class="sd">            total_proj: pd df</span>
<span class="sd">                Project level backup energy use</span>
<span class="sd">                and heat rates.</span>

<span class="sd">            ts_proj: dict</span>
<span class="sd">                Timestep project level results for energy use [W],</span>
<span class="sd">                and delivered heat rate [W].</span>

<span class="sd">            ts_cons: dict of dicts</span>
<span class="sd">                Timestep household level results for energy use [W],</span>
<span class="sd">                and delivered heat rate [W].</span>

<span class="sd">            Updates `self.cons_total` with the backup simulation</span>
<span class="sd">            energy use and heat rates results.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ts_proj</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_no_dist&#39;</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}</span>

        <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">season</span>

        <span class="n">ts_cons</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">cons_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="c1"># extract backup size for the household</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_sizes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">backup_sizes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">backup_heater</span> <span class="o">=</span> <span class="n">Storage</span><span class="p">(</span>
                <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backup_params</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
                <span class="n">timestep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;wham_tank&#39;</span><span class="p">,</span>
                <span class="n">log_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

            <span class="c1"># assuming the tank is indoors and using default</span>
            <span class="c1"># tank surrounding temperature</span>
            <span class="n">ind_load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loads</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">loads</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;load_m3&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">ind_res</span> <span class="o">=</span> <span class="n">backup_heater</span><span class="o">.</span><span class="n">gas_tank_wh</span><span class="p">(</span>
                <span class="n">ind_load</span><span class="p">,</span>
                <span class="n">T_feed</span><span class="p">,</span>
                <span class="n">T_amb</span><span class="o">=</span><span class="mf">291.48</span><span class="p">)</span>

            <span class="n">ind_res_no_dist_loss</span> <span class="o">=</span> <span class="n">backup_heater</span><span class="o">.</span><span class="n">gas_tank_wh</span><span class="p">(</span>
                <span class="n">ind_load</span><span class="p">,</span>
                <span class="n">T_feed_no_loss</span><span class="p">,</span>
                <span class="n">T_amb</span><span class="o">=</span><span class="mf">291.48</span><span class="p">)</span>

            <span class="c1"># rename key</span>
            <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ind_res</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del&#39;</span><span class="p">])</span>
            <span class="c1"># placeholder unmet load, not implemented in the comp. model</span>
            <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]]):</span>
                <span class="n">ts_proj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ind_res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_no_dist&#39;</span><span class="p">]]</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="n">ind_res_no_dist_loss</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]])</span>

            <span class="n">ts_cons</span><span class="p">[</span><span class="n">cons_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]:</span> <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]:</span> <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s&#39;</span><span class="p">]:</span> <span class="n">ind_res</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">it_is_summer</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w&#39;</span><span class="p">]:</span> <span class="n">ind_res</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">it_is_winter</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_no_dist&#39;</span><span class="p">]:</span> <span class="n">ind_res_no_dist_loss</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s_no_dist&#39;</span><span class="p">]:</span> <span class="n">ind_res_no_dist_loss</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">it_is_summer</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w_no_dist&#39;</span><span class="p">]:</span> <span class="n">ind_res_no_dist_loss</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">it_is_winter</span><span class="p">}</span>

            <span class="n">ts_cons</span><span class="p">[</span><span class="n">cons_id</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;season&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">season</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">it_is_summer</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ind_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">it_is_winter</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_no_dist&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ind_res_no_dist_loss</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s_no_dist&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ind_res_no_dist_loss</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">it_is_summer</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w_no_dist&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ind_res_no_dist_loss</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">it_is_winter</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ind_res</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cons_total</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="n">cons_id</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ind_res</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

        <span class="n">total_proj</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">ts_proj</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">it_is_summer</span><span class="p">)</span>

        <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">it_is_winter</span><span class="p">)</span>

        <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_s_no_dist&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_no_dist&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">it_is_summer</span><span class="p">)</span>

        <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_w_no_dist&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ts_proj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use_no_dist&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">it_is_winter</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">total_proj</span><span class="p">,</span> <span class="n">ts_proj</span><span class="p">,</span> <span class="n">ts_cons</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_split_utility</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Splits community level costs or energy use between the</span>
<span class="sd">        households based on a size defining variable,</span>
<span class="sd">        such as occupancy.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            df: pd df</span>
<span class="sd">                Contains household ID and split on column</span>

<span class="sd">            value: float</span>
<span class="sd">                Value to split among households</span>

<span class="sd">            var: str</span>
<span class="sd">                Label to store splitted values</span>

<span class="sd">            on: str</span>
<span class="sd">                Label for the column with weights</span>
<span class="sd">                (e.g. occupancy)</span>

<span class="sd">            drop: boolean</span>
<span class="sd">                Drops column used for calculating weights</span>
<span class="sd">                (&#39;on&#39; kwarg)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">on</span><span class="p">]</span> <span class="o">*</span> <span class="n">value</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">on</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">drop</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">on</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># return with a value distributed onto households</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_get_pump_energy_use</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist_pump_on_timestep_frac</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">gain_from_collector</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates pump energy use based on the load on the pump.</span>
<span class="sd">        We assume fixed_speed pumps and full load at each timestep when</span>
<span class="sd">        there is flow demand.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            dist_pump_on_timestep_frac: array, W</span>
<span class="sd">                Array with the fraction of distribution</span>
<span class="sd">                pump on time for each timestep</span>

<span class="sd">            gain_from_collector: array, W</span>
<span class="sd">                Array with load delivered from collector.</span>
<span class="sd">                Determines the operating hours for the solar</span>
<span class="sd">                pump. Assumption is that for each timestep in</span>
<span class="sd">                which the load exists, the pump is on for the</span>
<span class="sd">                full duration of the timestep</span>

<span class="sd">        Returns:</span>

<span class="sd">            el_use: dict, Wh</span>
<span class="sd">                Electricity consumption for the analyzed period by:</span>

<span class="sd">                * &#39;dist_pump&#39; - distribution pump</span>
<span class="sd">                * &#39;sol_pump&#39; - solar pump</span>
<span class="sd">                * &#39;total&#39; - total (all pumps in the system)</span>

<span class="sd">            op_hour: dict, h</span>
<span class="sd">                Operating hours for the analyzed period by:</span>

<span class="sd">                * &#39;dist_pump&#39; - distribution pump</span>
<span class="sd">                * &#39;sol_pump&#39; - solar pump</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ts_el_use</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">ts_el_use</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_timesteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">el_use</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">el_use</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="n">op_hour</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">pump</span> <span class="o">=</span> <span class="n">Distribution</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_params</span><span class="p">,</span>
            <span class="n">sizes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_sizes</span><span class="p">,</span>
            <span class="n">log_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dist_pump_on_timestep_frac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># get annual on hours</span>
            <span class="n">op_hour</span><span class="p">[</span><span class="s1">&#39;dist_pump&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist_pump_on_timestep_frac</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>

            <span class="n">ts_el_use</span><span class="p">[</span><span class="s1">&#39;dist_pump&#39;</span><span class="p">],</span> <span class="n">el_use</span><span class="p">[</span><span class="s1">&#39;dist_pump&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pump</span><span class="o">.</span><span class="n">pump</span><span class="p">(</span>
                <span class="n">on_array</span><span class="o">=</span><span class="n">dist_pump_on_timestep_frac</span><span class="p">,</span>
                <span class="n">role</span><span class="o">=</span><span class="s1">&#39;distribution&#39;</span><span class="p">)</span>

            <span class="n">ts_el_use</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ts_el_use</span><span class="p">[</span><span class="s1">&#39;dist_pump&#39;</span><span class="p">]</span>

            <span class="n">el_use</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">el_use</span><span class="p">[</span><span class="s1">&#39;dist_pump&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">gain_from_collector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># get annual on hours</span>
            <span class="n">on_array</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">*</span> <span class="p">(</span><span class="n">gain_from_collector</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">op_hour</span><span class="p">[</span><span class="s1">&#39;sol_pump&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">gain_from_collector</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>

            <span class="n">ts_el_use</span><span class="p">[</span><span class="s1">&#39;sol_pump&#39;</span><span class="p">],</span> <span class="n">el_use</span><span class="p">[</span><span class="s1">&#39;sol_pump&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pump</span><span class="o">.</span><span class="n">pump</span><span class="p">(</span>
                <span class="n">on_array</span><span class="o">=</span><span class="n">on_array</span><span class="p">,</span>
                <span class="n">role</span><span class="o">=</span><span class="s1">&#39;solar&#39;</span><span class="p">)</span>

            <span class="n">ts_el_use</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ts_el_use</span><span class="p">[</span><span class="s1">&#39;sol_pump&#39;</span><span class="p">]</span>

            <span class="n">el_use</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">el_use</span><span class="p">[</span><span class="s1">&#39;sol_pump&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">ts_el_use</span><span class="p">,</span> <span class="n">el_use</span><span class="p">,</span> <span class="n">op_hour</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 
Multiscale Solar Water Heating (MSWH) Copyright (c) 2019, The
Regents of the University of California, through Lawrence Berkeley National
Laboratory (subject to receipt of any required approvals from the U.S.
Dept. of Energy).  All rights reserved.

If you have questions about your rights to use or distribute this software,
please contact Berkeley Lab&#39;s Intellectual Property Office at
IPO@lbl.gov.

NOTICE.  This Software was developed under funding from the U.S. Department
of Energy and the U.S. Government consequently retains certain rights.  As
such, the U.S. Government has been granted for itself and others acting on
its behalf a paid-up, nonexclusive, irrevocable, worldwide license in the
Software to reproduce, distribute copies to the public, prepare derivative
works, and perform publicly and display publicly, and to permit other to do
so.


    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>